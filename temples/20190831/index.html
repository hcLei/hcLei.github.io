<!DOCTYPE html>
<html>

<head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
        <title>Vue全家桶 + Koa实现的在线云盘</title>
        <link rel='stylesheet' href='../../public/markdown.min.css' />
        <link rel='stylesheet' href='../../public/style.css' />
        <link rel="icon" type="image/png" href="../../public/images/icon.png" sizes="32x32">
        <meta name="description"
                content="个人博客网站，专注于分享技术知识，包括但不限于HTML5、CSS3、JavaScript、Nodejs、Linux、Python、Nginx、React、Vue、Angular">
        <meta name="keywords"
                content="个人、博客、技术、互联网、分享、笔记、前端开发、HTML5、CSS3、JavaScript、Nodejs、Linux、Python、Nginx、React、Vue、Angular">
</head>

<body>
        <header class="header">
                <div class="header-inner">
                        <div class="header-title">
                                <a href="../../">致力于分享与进步</a>
                        </div>
                </div>
        </header>
        <main class="main">
                <div class="main-inner">
                        <div class="content-item">
                                <p class="content-title"><a>Vue全家桶 + Koa实现的在线云盘</a></p>
                                <p class="content-createTime"><img src="../../public/images/date.svg" alt="date">发表于
                                        2019-08-31</p>
                        </div>
                        <div class="content-description">
                                <p>好久没有使用 Vue 开发应用，很多知识都忘得差不多了。趁着业余时间搞了一个项目，熟悉相关的技术知识，<a
                                                href="https://github.com/hcLei/skydrive">项目地址</a>。使用了 Vue 全家桶和 Nodejs
                                        等前后端技术开发的一款在线网盘，后续会开发更多功能。</p>
                                <p><strong>技术栈</strong></p>
                                <ul>
                                        <li>Vue</li>
                                        <li>Vue-router</li>
                                        <li>Vuex</li>
                                        <li>Element UI</li>
                                        <li>Axios</li>
                                        <li>Koa</li>
                                        <li>MongoDB</li>
                                </ul>
                                <p><strong>功能点</strong></p>
                                <ul>
                                        <li>支持账户登陆注册，采用Token实现身份认证</li>
                                        <li>支持上传、下载、移动、修改、删除等操作文件或者文件夹</li>
                                        <li>支持访问日志记录和错误日志记录</li>
                                </ul>
                                <p><strong>文章目录</strong><br>一、整体目录结构<br>二、数据库设计<br>三、Router 配置<br>四、Store
                                        配置<br>五、封装HTTP请求<br>六、注册登陆<br>七、上传文件<br>八、下载文件<br>九、日志记录<br>十、koa 插件配置 </p>
                                <hr>
                                <h5 id="h5--"><a name="一、整体目录结构" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>一、整体目录结构</h5>
                                <p>1.<br><img src="../../public/images/20190831/1.png" alt="1"> </p>
                                <p>2.</p>
                                <p><img src="../../public/images/20190831/2.png" alt="2"> </p>
                                <p>3.</p>
                                <p><img src="../../public/images/20190831/3.png" alt="3"> </p>
                                <h5 id="h5--"><a name="二、数据库设计" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>二、数据库设计</h5>
                                <p>使用的是 MongoDB
                                        文档型数据库(Mysql属于关系型数据库)。由于本次实现的是一个云盘，主要是目录与子目录的关系，所以整体是一个树状结构。<br>在设计数据库时，并不是通过维护一个嵌套的对象，而是将所有的数据都放入到一维数组，父子关系通过<code>parId</code>字段来维护，根目录到当前所在目录通过<code>pathRoot</code>字段来维护。只考虑相邻的两级关系，不考虑所有的层级关系，优势如下：
                                </p>
                                <ol>
                                        <li>存入数据时，只需要将<code>parId</code>设为当前目录的Id，<code>pathRoot</code>设为根目录到当前目录的路径。而不是通过递归对象将数据放到对应的节点上。
                                        </li>
                                        <li>修改当前文件或者目录名称时，只需要根据当前数据的Id去数据库匹配然后修改。如果修改的是目录名称(假如nameA修改为nameB)，会影响该目录下所有子目录和子文件的<code>pathRoot</code>字段，那么只需要匹配所有满足<code>pathRoot</code>字段里面包含nameA的数据，然后替换成nameB就可以了。
                                        </li>
                                        <li>移动文件或目录时，所有的子目录或者文件也会跟着变化。修改当前文件或目录的<code>parId</code>字段，指向新的目录Id，同样也要修改所有子目录或者子文件的<code>pathRoot</code>字段，同上。
                                        </li>
                                        <li>删除文件或目录时，根据当前的Id去数据库匹配删除。如果删除的目录里面有子目录或者文件(假如删除的是目录folderA)，那么只需要匹配所有满足<code>pathRoot</code>字段里面包含folderA的数据，然后全部删除。最后记得也要删除磁盘文件，不然内存消耗太大(如果有回收站保留30天，则设置最后保留时间，超时后再去删磁盘文件)。
                                        </li>
                                </ol>
                                <h5 id="h5--router-"><a name="三、Router 配置" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>三、Router 配置</h5>
                                <p>路由配置文件，某些需要身份验证的路由使用了<a
                                                href="https://router.vuejs.org/zh/guide/advanced/navigation-guards.html">Vue
                                                Router 导航守卫用法</a>来进行跳转前的判断拦截。</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//Router配置</span></code></li><li class="L1"><code class="lang-javascript"><span class="typ">Vue</span><span class="pun">.</span><span class="pln">use</span><span class="pun">(</span><span class="typ">VueRouter</span><span class="pun">)</span></code></li><li class="L2"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> router </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">VueRouter</span><span class="pun">({</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> mode</span><span class="pun">:</span><span class="pln"> </span><span class="str">'history'</span><span class="pun">,</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> routes</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[{</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> path</span><span class="pun">:</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">,</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> component</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Login</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},{</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> path</span><span class="pun">:</span><span class="pln"> </span><span class="str">'/cloud'</span><span class="pun">,</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> component</span><span class="pun">:</span><span class="pln"> </span><span class="typ">CloudDisk</span><span class="pun">,</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> meta</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//需要身份校验的路由</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> requireAuth</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},{</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> path</span><span class="pun">:</span><span class="pln"> </span><span class="str">'*'</span><span class="pun">,</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> component</span><span class="pun">:</span><span class="pln"> </span><span class="typ">NotFound</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}]</span></code></li><li class="L7"><code class="lang-javascript"><span class="pun">})</span></code></li><li class="L8"><code class="lang-javascript"><span class="com">//路由认证--身份校验不通过则跳转到登陆界面</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln">router</span><span class="pun">.</span><span class="pln">beforeEach</span><span class="pun">((</span><span class="pln">to</span><span class="pun">,</span><span class="pln"> from</span><span class="pun">,</span><span class="pln"> next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> token </span><span class="pun">=</span><span class="pln"> store</span><span class="pun">.</span><span class="pln">state</span><span class="pun">.</span><span class="pln">token</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">to</span><span class="pun">.</span><span class="pln">matched</span><span class="pun">.</span><span class="pln">some</span><span class="pun">(</span><span class="pln"> record </span><span class="pun">=&gt;</span><span class="pln"> record</span><span class="pun">.</span><span class="pln">meta</span><span class="pun">.</span><span class="pln">requireAuth</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> </span><span class="pun">!</span><span class="pln">token</span><span class="pun">){</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> next</span><span class="pun">({</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> path</span><span class="pun">:</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">,</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> query</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">redirect</span><span class="pun">:</span><span class="pln"> to</span><span class="pun">.</span><span class="pln">fullPath</span><span class="pun">}</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="pun">})</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span><span class="kwd">else</span><span class="pun">{</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> next</span><span class="pun">()</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L9"><code class="lang-javascript"><span class="pun">})</span></code></li></ol></pre>
                                <h5 id="h5--store-"><a name="四、Store 配置" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>四、Store 配置</h5>
                                <p>小项目是没必要使用该技术的 <a
                                                href="https://vuex.vuejs.org/zh/guide/state.html">Vuex</a>，只是熟悉其用法才在本次项目开发中使用。
                                </p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> store </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Vuex</span><span class="pun">.</span><span class="typ">Store</span><span class="pun">({</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//单一数据源</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> token</span><span class="pun">:</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">getItem</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">),</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> userName</span><span class="pun">:</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">getItem</span><span class="pun">(</span><span class="str">'userName'</span><span class="pun">),</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> userId</span><span class="pun">:</span><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">getItem</span><span class="pun">(</span><span class="str">'userId'</span><span class="pun">)</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> mutations</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//更改 store 中的状态，通过commit来触发</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> LOGIN</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//登陆</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">userName </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">userName</span><span class="pun">;</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">userId </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">userId</span><span class="pun">;</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">token </span><span class="pun">=</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">token</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">setItem</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">token</span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">setItem</span><span class="pun">(</span><span class="str">'userName'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">userName</span><span class="pun">);</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">setItem</span><span class="pun">(</span><span class="str">'userId'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">.</span><span class="pln">userId</span><span class="pun">);</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> LOGOUT</span><span class="pun">:</span><span class="pln"> </span><span class="pun">(</span><span class="pln">state</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//注销</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">userName </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">userId </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> state</span><span class="pun">.</span><span class="pln">token </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">removeItem</span><span class="pun">(</span><span class="str">'token'</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">removeItem</span><span class="pun">(</span><span class="str">'userName'</span><span class="pun">);</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> window</span><span class="pun">.</span><span class="pln">localStorage</span><span class="pun">.</span><span class="pln">removeItem</span><span class="pun">(</span><span class="str">'userId'</span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> actions</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//触发更改状态的行为（如果是异步操作，则需要使用action；如果是同步行为，则可以直接使用mutations，不需要使用action触发commit）</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="typ">UserLogin</span><span class="pun">({</span><span class="pln"> commit </span><span class="pun">},</span><span class="pln"> data</span><span class="pun">){</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="com">//异步操作...</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> commit</span><span class="pun">(</span><span class="str">'LOGIN'</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="typ">UserLogout</span><span class="pun">({</span><span class="pln"> commit </span><span class="pun">}){</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="com">//异步操作...</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> commit</span><span class="pun">(</span><span class="str">'LOGOUT'</span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L4"><code class="lang-javascript"><span class="pun">});</span></code></li></ol></pre>
                                <p>具体的 **.vue
                                        文件用法<br><code>this.$store.dispatch('UserLogin', data);</code><br><code>this.$store.dispatch('UserLogout', data);</code>
                                </p>
                                <h5 id="h5--http-"><a name="五、封装HTTP请求" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>五、封装HTTP请求</h5>
                                <p>使用的是<code>axios</code>，然后结合实际项目需求和接口返回的状态码进行统一封装，比如界面错误提示或者身份认证不通过强制跳转等行为，在外层统一处理，避免在每个实际的HTTP请求后的回调里重复处理。
                                </p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="kwd">import</span><span class="pln"> axios from </span><span class="str">'axios'</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="kwd">import</span><span class="pln"> store from </span><span class="str">'./store.js'</span><span class="pun">;</span></code></li><li class="L2"><code class="lang-javascript"><span class="kwd">import</span><span class="pln"> router from </span><span class="str">'./router.js'</span><span class="pun">;</span></code></li><li class="L3"><code class="lang-javascript"><span class="kwd">import</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="typ">Message</span><span class="pln"> </span><span class="pun">}</span><span class="pln"> from </span><span class="str">'element-ui'</span><span class="pun">;</span></code></li><li class="L4"><code class="lang-javascript"></code></li><li class="L5"><code class="lang-javascript"><span class="com">//创建axios实例</span></code></li><li class="L6"><code class="lang-javascript"><span class="kwd">var</span><span class="pln"> instance </span><span class="pun">=</span><span class="pln"> axios</span><span class="pun">.</span><span class="pln">create</span><span class="pun">({</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> baseURL</span><span class="pun">:</span><span class="pln"> url</span><span class="pun">,</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> timeout</span><span class="pun">:</span><span class="pln"> </span><span class="lit">7000</span><span class="pun">,</span><span class="pln"> </span><span class="com">//超时返回错误</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> headers</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">'Content-Type'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'application/json;charset=UTF-8'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> withCredentials</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pln"> </span><span class="com">//跨域配置</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">});</span></code></li><li class="L2"><code class="lang-javascript"></code></li><li class="L3"><code class="lang-javascript"><span class="com">//request拦截器</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln">instance</span><span class="pun">.</span><span class="pln">interceptors</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">use</span><span class="pun">(</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> config </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> config</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">[</span><span class="str">'skyAuth'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">`</span><span class="pln">aut$</span><span class="pun">{</span><span class="pln">store</span><span class="pun">.</span><span class="pln">state</span><span class="pun">.</span><span class="pln">token</span><span class="pun">}`</span><span class="pln"> </span><span class="com">//自定义header-token</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> config</span><span class="pun">.</span><span class="pln">headers</span><span class="pun">[</span><span class="str">'authId'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">`</span><span class="pln">ati$</span><span class="pun">{</span><span class="pln">store</span><span class="pun">.</span><span class="pln">state</span><span class="pun">.</span><span class="pln">userId</span><span class="pun">}`</span><span class="pln"> </span><span class="com">//自定义header-authId</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> config</span><span class="pun">;</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L0"><code class="lang-javascript"><span class="pun">);</span></code></li><li class="L1"><code class="lang-javascript"><span class="com">//respone拦截器</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln">instance</span><span class="pun">.</span><span class="pln">interceptors</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">use</span><span class="pun">(</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> response </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="com">//status==200统一提示(对于不希望提示的某些操作，则判断是否有message)</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> tip </span><span class="pun">=</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">message</span><span class="pun">;</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">tip</span><span class="pun">){</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="typ">Message</span><span class="pun">({</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">message</span><span class="pun">,</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> type</span><span class="pun">:</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">.</span><span class="pln">status</span><span class="pun">,</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> center</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">});</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">data</span><span class="pun">;</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> error </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//错误处理</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">response</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="com">//错误状态码统一提示</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="typ">Message</span><span class="pun">({</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> error</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">statusText</span><span class="pun">,</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'error'</span><span class="pun">,</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> center</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">});</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">switch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">response</span><span class="pun">.</span><span class="pln">status</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">case</span><span class="pln"> </span><span class="lit">401</span><span class="pun">:</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> store</span><span class="pun">.</span><span class="pln">dispatch</span><span class="pun">(</span><span class="str">'UserLogout'</span><span class="pun">);</span><span class="pln"> </span><span class="com">//重新认证</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> router</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">({</span><span class="pln"> </span><span class="com">//跳转到登录页面</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> path</span><span class="pun">:</span><span class="pln"> </span><span class="str">'/'</span><span class="pun">,</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> query</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> redirect</span><span class="pun">:</span><span class="pln"> router</span><span class="pun">.</span><span class="pln">currentRoute</span><span class="pun">.</span><span class="pln">fullPath </span><span class="pun">}</span><span class="pln"> </span><span class="com">// 将跳转的路由path作为参数，登录成功后跳转到该路由</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="pun">});</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span><span class="kwd">else</span><span class="pun">{</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="com">//网络错误统一提示</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="typ">Message</span><span class="pun">({</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> error</span><span class="pun">,</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'error'</span><span class="pun">,</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> center</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="pun">});</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span><span class="typ">Promise</span><span class="pun">.</span><span class="pln">reject</span><span class="pun">(</span><span class="pln">error</span><span class="pun">.</span><span class="pln">response</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="kwd">export</span><span class="pln"> </span><span class="kwd">default</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="com">//封装get请求</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> getService</span><span class="pun">(</span><span class="pln">url</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> instance</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">url</span><span class="pun">);</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="com">//封装post请求</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> postService</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> instance</span><span class="pun">.</span><span class="pln">post</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> data</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <p>封装后，具体的场景使用：</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="kwd">import</span><span class="pln"> http from </span><span class="str">"../http.js"</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="com">//get请求</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln">http</span><span class="pun">.</span><span class="pln">getService</span><span class="pun">(</span><span class="pln">path</span><span class="pun">).</span><span class="pln">then</span><span class="pun">(</span><span class="pln">res </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">。。。</span></code></li><li class="L4"><code class="lang-javascript"><span class="pun">}).</span><span class="kwd">catch</span><span class="pun">(</span><span class="pln">err </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{})</span></code></li><li class="L5"><code class="lang-javascript"><span class="com">//post请求</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln">http</span><span class="pun">.</span><span class="pln">postService</span><span class="pun">(</span><span class="pln">path</span><span class="pun">,</span><span class="pln"> params</span><span class="pun">).</span><span class="pln">then</span><span class="pun">(</span><span class="pln">res </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="pun">。。。</span></code></li><li class="L8"><code class="lang-javascript"><span class="pun">}).</span><span class="kwd">catch</span><span class="pun">(</span><span class="pln">err </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{})</span></code></li></ol></pre>
                                <h5 id="h5--"><a name="六、注册登陆" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>六、注册登陆</h5>
                                <p>账号密码都有输入校验，注册时会先根据用户名匹配数据库是否有同名账号(使用<code>sha1</code>加密账号密码)，登陆时后台会生成随机Token(使用<code>jsonwebtoken</code>)发送到前台，并放入到
                                        Http header里边作为后续的请求身份校验：</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//前台输入校验，web攻击是可以绕过前台的校验，为了保证安全，后台也要进行校验：</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln">rules</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> name</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> required</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'请输入账号'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'change'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> min</span><span class="pun">:</span><span class="pln"> </span><span class="lit">5</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">:</span><span class="pln"> </span><span class="lit">7</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'长度在 5 到 7 个字符'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'blur'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">/^[(\u4e00-\u9fa5)|(a-zA-Z0-9)]+$/</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'输入格式有误，只支持中文、英文或数字'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'change'</span><span class="pln"> </span><span class="pun">}</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">],</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> pwd</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> required</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'请输入密码'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'change'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> min</span><span class="pun">:</span><span class="pln"> </span><span class="lit">8</span><span class="pun">,</span><span class="pln"> max</span><span class="pun">:</span><span class="pln"> </span><span class="lit">16</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'长度在 8 到 16 个字符'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'blur'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span><span class="pln"> pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">/^[(a-zA-Z0-9\.)]+$/</span><span class="pun">,</span><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">'输入格式有误，只支持英文、数字或.'</span><span class="pun">,</span><span class="pln"> trigger</span><span class="pun">:</span><span class="pln"> </span><span class="str">'change'</span><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">]</span></code></li><li class="L2"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//后台创建token</span></code></li><li class="L1"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> jwt </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">'jsonwebtoken'</span><span class="pun">);</span><span class="com">//token中间件</span></code></li><li class="L2"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> createToken </span><span class="pun">=</span><span class="pln"> user </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> token </span><span class="pun">=</span><span class="pln"> jwt</span><span class="pun">.</span><span class="pln">sign</span><span class="pun">(</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> user</span><span class="pun">:</span><span class="pln"> user</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="str">'skydrivelhc'</span><span class="pun">,</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> expiresIn</span><span class="pun">:</span><span class="pln"> </span><span class="str">'10m'</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span><span class="pln"> token</span><span class="pun">;</span></code></li><li class="L3"><code class="lang-javascript"><span class="pun">}</span></code></li><li class="L4"><code class="lang-javascript"><span class="com">//后台校验token</span></code></li><li class="L5"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> checkToken </span><span class="pun">=</span><span class="pln"> async </span><span class="pun">(</span><span class="pln">ctx</span><span class="pun">,</span><span class="pln"> next</span><span class="pun">)</span><span class="pln"> </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> await next</span><span class="pun">();</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> authToken </span><span class="pun">=</span><span class="pln"> ctx</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'skyAuth'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">||</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">query</span><span class="pun">.</span><span class="pln">skyAuth</span><span class="pun">;</span><span class="pln"> </span><span class="com">//如果是下载文件，get请求的认证信息是放到url参数上面的</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(!</span><span class="pln">authToken</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">status </span><span class="pun">=</span><span class="pln"> </span><span class="lit">401</span><span class="pun">;</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">body </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> status</span><span class="pun">:</span><span class="pln"> </span><span class="str">"error"</span><span class="pun">,</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">"身份认证失败"</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="pun">};</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> token </span><span class="pun">=</span><span class="pln"> authToken</span><span class="pun">.</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">3</span><span class="pun">);</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">try</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> await jwt</span><span class="pun">.</span><span class="pln">verify</span><span class="pun">(</span><span class="pln">token</span><span class="pun">,</span><span class="pln"> </span><span class="str">'skydrivelhc'</span><span class="pun">);</span><span class="pln"> </span><span class="com">//如果校验不通过，会抛出异常</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span><span class="pln"> </span><span class="kwd">catch</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">status </span><span class="pun">=</span><span class="pln"> </span><span class="lit">401</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">body </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> status</span><span class="pun">:</span><span class="pln"> </span><span class="str">"error"</span><span class="pun">,</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> </span><span class="str">"身份认证失败"</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="pun">};</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L7"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <h5 id="h5--"><a name="七、上传文件" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>七、上传文件</h5>
                                <p>前台自定义ajax请求：</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//html代码</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">&lt;</span><span class="pln">div title</span><span class="pun">=</span><span class="str">""</span><span class="pln"> </span><span class="kwd">class</span><span class="pun">=</span><span class="str">"cloud__upload"</span><span class="pun">&gt;&lt;</span><span class="pln">input name</span><span class="pun">=</span><span class="str">"file"</span><span class="pln"> value</span><span class="pun">=</span><span class="str">"upload"</span><span class="pln"> </span><span class="lit">@change</span><span class="pun">=</span><span class="str">"uploadFile($event)"</span><span class="pln"> type</span><span class="pun">=</span><span class="str">"file"</span><span class="pln"> </span><span class="pun">/&gt;&lt;/</span><span class="pln">div</span><span class="pun">&gt;</span></code></li><li class="L2"><code class="lang-javascript"></code></li><li class="L3"><code class="lang-javascript"><span class="com">//js代码</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln">uploadFile</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//上传文件</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> document </span><span class="pun">=</span><span class="pln"> e</span><span class="pun">.</span><span class="pln">target</span><span class="pun">;</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> file </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">files</span><span class="pun">[</span><span class="lit">0</span><span class="pun">];</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">file</span><span class="pun">.</span><span class="pln">size </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1000</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> messageShow</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'文件大小不能超过10M'</span><span class="pun">);</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> let _this </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">;</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="com">//创建formdata对象</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> let formData </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">FormData</span><span class="pun">();</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> formData</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">);</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> formData</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="str">'foldId'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">curFoldId</span><span class="pun">);</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> formData</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="str">'pathRoot'</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">this</span><span class="pun">.</span><span class="pln">pathRoot</span><span class="pun">.</span><span class="pln">concat</span><span class="pun">(</span><span class="kwd">this</span><span class="pun">.</span><span class="pln">curFoldId</span><span class="pun">));</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> let xhr </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">XMLHttpRequest</span><span class="pun">();</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">open</span><span class="pun">(</span><span class="str">'post'</span><span class="pun">,</span><span class="pln"> url</span><span class="pun">);</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">setRequestHeader</span><span class="pun">(</span><span class="str">'skyAuth'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">`</span><span class="pln">aut$</span><span class="pun">{</span><span class="pln">store</span><span class="pun">.</span><span class="pln">state</span><span class="pun">.</span><span class="pln">token</span><span class="pun">}`);</span><span class="pln"> </span><span class="com">//涉及到认证，需要自定义header头部</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">setRequestHeader</span><span class="pun">(</span><span class="str">'authId'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">`</span><span class="pln">aut$</span><span class="pun">{</span><span class="pln">store</span><span class="pun">.</span><span class="pln">state</span><span class="pun">.</span><span class="pln">userId</span><span class="pun">}`);</span><span class="pln"> </span><span class="com">//自定义header头部</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">onreadystatechange </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">xhr</span><span class="pun">.</span><span class="pln">readyState </span><span class="pun">==</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">status </span><span class="pun">==</span><span class="pln"> </span><span class="lit">200</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> response </span><span class="pun">=</span><span class="pln"> JSON</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">xhr</span><span class="pun">.</span><span class="pln">responseText</span><span class="pun">);</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> messageShow</span><span class="pun">(</span><span class="pln">response</span><span class="pun">.</span><span class="pln">status</span><span class="pun">,</span><span class="pln"> response</span><span class="pun">.</span><span class="pln">message</span><span class="pun">,</span><span class="pln"> _this</span><span class="pun">);</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> _this</span><span class="pun">.</span><span class="pln">$emit</span><span class="pun">(</span><span class="str">'cloud_list_handel'</span><span class="pun">,</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'uploadOk'</span><span class="pln"> </span><span class="pun">});</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> document</span><span class="pun">.</span><span class="pln">value </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span><span class="pln"> </span><span class="com">//需要清除value，否则第二次选择同样文件时无反应</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">xhr</span><span class="pun">.</span><span class="pln">readyState </span><span class="pun">==</span><span class="pln"> </span><span class="lit">4</span><span class="pln"> </span><span class="pun">&amp;&amp;</span><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">status </span><span class="pun">!==</span><span class="pln"> </span><span class="lit">200</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> messageShow</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'上传失败'</span><span class="pun">,</span><span class="pln"> _this</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> document</span><span class="pun">.</span><span class="pln">value </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="pun">};</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">upload</span><span class="pun">.</span><span class="pln">onprogress </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">e</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="com">//进度条</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">lengthComputable</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> _this</span><span class="pun">.</span><span class="pln">percent </span><span class="pun">=</span><span class="pln"> e</span><span class="pun">.</span><span class="pln">loaded </span><span class="pun">/</span><span class="pln"> e</span><span class="pun">.</span><span class="pln">total </span><span class="pun">*</span><span class="pln"> </span><span class="lit">100</span><span class="pun">;</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">upload</span><span class="pun">.</span><span class="pln">onerror </span><span class="pun">=</span><span class="pln"> </span><span class="kwd">function</span><span class="pln"> </span><span class="pun">(</span><span class="pln">err</span><span class="pun">)</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> messageShow</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> </span><span class="str">'网络连接失败'</span><span class="pun">,</span><span class="pln"> _this</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> document</span><span class="pun">.</span><span class="pln">value </span><span class="pun">=</span><span class="pln"> </span><span class="str">""</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> xhr</span><span class="pun">.</span><span class="pln">send</span><span class="pun">(</span><span class="pln">formData</span><span class="pun">);</span></code></li><li class="L3"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <p>后台接收文件，先将本次操作存储到数据库，再将文件放到磁盘，考虑到不同的目录可能会有相同的文件，所以磁盘文件以数据库的唯一id字段命名，而不是上传时的名称，下载文件的时候再根据数据库存储的文件名称替换就行了：
                                </p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> file </span><span class="pun">=</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">files</span><span class="pun">.</span><span class="pln">file</span><span class="pun">;</span></code></li><li class="L1"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> creator </span><span class="pun">=</span><span class="pln"> ctx</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="str">'authId'</span><span class="pun">).</span><span class="pln">slice</span><span class="pun">(</span><span class="lit">3</span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="com">//校验数据库中是否已存在同名</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln">let validRes </span><span class="pun">=</span><span class="pln"> await validSameName</span><span class="pun">({</span><span class="pln">parId</span><span class="pun">:</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">foldId</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">:</span><span class="pln"> file</span><span class="pun">.</span><span class="pln">name</span><span class="pun">,</span><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'file'</span><span class="pun">,</span><span class="pln"> creator</span><span class="pun">});</span></code></li><li class="L4"><code class="lang-javascript"><span class="kwd">if</span><span class="pun">(</span><span class="pln">validRes</span><span class="pun">){</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">body </span><span class="pun">=</span><span class="pln"> validRes</span><span class="pun">;</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span></code></li><li class="L7"><code class="lang-javascript"><span class="pun">}</span></code></li><li class="L8"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> newFile </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> name</span><span class="pun">:</span><span class="pln"> file</span><span class="pun">.</span><span class="pln">name</span><span class="pun">,</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'file'</span><span class="pun">,</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> size</span><span class="pun">:</span><span class="pln"> file</span><span class="pun">.</span><span class="pln">size</span><span class="pun">,</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> updateTime</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">new</span><span class="pln"> </span><span class="typ">Date</span><span class="pun">().</span><span class="pln">getTime</span><span class="pun">(),</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> parId</span><span class="pun">:</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">foldId</span><span class="pun">,</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> pathRoot</span><span class="pun">:</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">pathRoot</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">","</span><span class="pun">),</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> creator</span></code></li><li class="L6"><code class="lang-javascript"><span class="pun">}</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln">let doc </span><span class="pun">=</span><span class="pln"> await addList</span><span class="pun">(</span><span class="pln">newFile</span><span class="pun">);</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln">ctx</span><span class="pun">.</span><span class="pln">status </span><span class="pun">=</span><span class="pln"> </span><span class="lit">200</span><span class="pun">;</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln">ctx</span><span class="pun">.</span><span class="pln">body </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> status</span><span class="pun">:</span><span class="pln"> doc </span><span class="pun">?</span><span class="pln"> </span><span class="str">"success"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"error"</span><span class="pun">,</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln"> message</span><span class="pun">:</span><span class="pln"> doc </span><span class="pun">?</span><span class="pln"> </span><span class="str">"上传文件成功"</span><span class="pln"> </span><span class="pun">:</span><span class="pln"> </span><span class="str">"上传文件失败"</span><span class="pun">,</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> data</span><span class="pun">:</span><span class="pln"> doc </span><span class="pun">||</span><span class="pln"> </span><span class="pun">[]</span></code></li><li class="L3"><code class="lang-javascript"><span class="pun">}</span></code></li><li class="L4"><code class="lang-javascript"><span class="com">//存入磁盘</span></code></li><li class="L5"><code class="lang-javascript"><span class="kwd">if</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">){</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> reader </span><span class="pun">=</span><span class="pln"> fs</span><span class="pun">.</span><span class="pln">createReadStream</span><span class="pun">(</span><span class="pln">file</span><span class="pun">.</span><span class="pln">path</span><span class="pun">);</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> filePath </span><span class="pun">=</span><span class="pln"> path</span><span class="pun">.</span><span class="pln">resolve</span><span class="pun">(</span><span class="pln">__dirname</span><span class="pun">,</span><span class="pln"> </span><span class="str">'..'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/static/upload/'</span><span class="pun">;</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> wirter </span><span class="pun">=</span><span class="pln"> fs</span><span class="pun">.</span><span class="pln">createWriteStream</span><span class="pun">(</span><span class="pln">filePath </span><span class="pun">+</span><span class="pln"> doc</span><span class="pun">.</span><span class="pln">_id</span><span class="pun">);</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> reader</span><span class="pun">.</span><span class="pln">pipe</span><span class="pun">(</span><span class="pln">wirter</span><span class="pun">);</span></code></li><li class="L0"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <h5 id="h5--"><a name="八、下载文件" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>八、下载文件</h5>
                                <p>前台自定义a标签，注意携带身份认证信息：</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="pln">let link </span><span class="pun">=</span><span class="pln"> document</span><span class="pun">.</span><span class="pln">createElement</span><span class="pun">(</span><span class="str">'a'</span><span class="pun">);</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln">link</span><span class="pun">.</span><span class="pln">setAttribute</span><span class="pun">(</span><span class="str">"href"</span><span class="pun">,</span><span class="pln"> </span><span class="pun">`</span><span class="pln">http</span><span class="pun">:</span><span class="com">//localhost:3000/api/downloadfile?fileId=${file._id}&amp;skyAuth=aut${this.$store.state.token}`);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln">link</span><span class="pun">.</span><span class="pln">setAttribute</span><span class="pun">(</span><span class="str">"download"</span><span class="pun">,</span><span class="pln"> file</span><span class="pun">.</span><span class="pln">name</span><span class="pun">);</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln">link</span><span class="pun">.</span><span class="pln">style</span><span class="pun">.</span><span class="pln">visibility </span><span class="pun">=</span><span class="pln"> </span><span class="str">'hidden'</span><span class="pun">;</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln">document</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">appendChild</span><span class="pun">(</span><span class="pln">link</span><span class="pun">);</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln">link</span><span class="pun">.</span><span class="pln">click</span><span class="pun">();</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln">document</span><span class="pun">.</span><span class="pln">body</span><span class="pun">.</span><span class="pln">removeChild</span><span class="pun">(</span><span class="pln">link</span><span class="pun">);</span></code></li></ol></pre>
                                <p>后台下载文件：</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="pln">let doc </span><span class="pun">=</span><span class="pln"> await queryList</span><span class="pun">({</span><span class="pln">_id</span><span class="pun">:</span><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">request</span><span class="pun">.</span><span class="pln">query</span><span class="pun">.</span><span class="pln">fileId</span><span class="pun">});</span></code></li><li class="L1"><code class="lang-javascript"><span class="kwd">if</span><span class="pun">(</span><span class="pln">doc </span><span class="pun">&amp;&amp;</span><span class="pln"> doc</span><span class="pun">.</span><span class="pln">length </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">){</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> filePath </span><span class="pun">=</span><span class="pln"> path</span><span class="pun">.</span><span class="pln">resolve</span><span class="pun">(</span><span class="pln">__dirname</span><span class="pun">,</span><span class="pln"> </span><span class="str">'..'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'/static/upload/'</span><span class="pun">;</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">const</span><span class="pln"> reader </span><span class="pun">=</span><span class="pln"> fs</span><span class="pun">.</span><span class="pln">createReadStream</span><span class="pun">(</span><span class="pln">filePath </span><span class="pun">+</span><span class="pln"> doc</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">_id</span><span class="pun">);</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="kwd">set</span><span class="pun">(</span><span class="str">'Content-disposition'</span><span class="pun">,`</span><span class="pln">attachment</span><span class="pun">;</span><span class="pln">filename</span><span class="pun">=</span><span class="pln">$</span><span class="pun">{</span><span class="pln">encodeURI</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">[</span><span class="lit">0</span><span class="pun">].</span><span class="pln">name</span><span class="pun">)}`);</span><span class="pln"> </span><span class="com">//涉及到中文需要编码</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> ctx</span><span class="pun">.</span><span class="pln">body </span><span class="pun">=</span><span class="pln"> reader </span><span class="com">// 返回在响应体里</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">return</span></code></li><li class="L7"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <h5 id="h5--"><a name="九、日志记录" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>九、日志记录</h5>
                                <p>引入了<code>log4js</code>插件来记录日志，目前配置两种类型：访问日志和错误日志。为了避免日志文件过于庞大，按照日期来存储:yyyy-mm-dd-info.log
                                        和 yyyy-mm-dd-err.log。</p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//日志记录</span></code></li><li class="L1"><code class="lang-javascript"><span class="kwd">const</span><span class="pln"> log4js </span><span class="pun">=</span><span class="pln"> require</span><span class="pun">(</span><span class="str">'log4js'</span><span class="pun">);</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln">log4js</span><span class="pun">.</span><span class="pln">configure</span><span class="pun">({</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> appenders</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> info</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'dateFile'</span><span class="pun">,</span><span class="pln"> filename</span><span class="pun">:</span><span class="pln"> </span><span class="str">'./logs/logs'</span><span class="pln"> </span><span class="pun">,</span><span class="pln"> pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">'yyyy-MM-dd-info.log'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"alwaysIncludePattern"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">},</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln"> error</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> type</span><span class="pun">:</span><span class="pln"> </span><span class="str">'dateFile'</span><span class="pun">,</span><span class="pln"> filename</span><span class="pun">:</span><span class="pln"> </span><span class="str">'./logs/logs'</span><span class="pln"> </span><span class="pun">,</span><span class="pln"> pattern</span><span class="pun">:</span><span class="pln"> </span><span class="str">'yyyy-MM-dd-err.log'</span><span class="pun">,</span><span class="pln"> </span><span class="str">"alwaysIncludePattern"</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">}</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> </span><span class="pun">},</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> categories</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> </span><span class="kwd">default</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> appenders</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="str">'info'</span><span class="pun">],</span><span class="pln"> level</span><span class="pun">:</span><span class="pln"> </span><span class="str">'info'</span><span class="pln"> </span><span class="pun">},</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> error </span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span><span class="pln">appenders</span><span class="pun">:</span><span class="pln"> </span><span class="pun">[</span><span class="str">'error'</span><span class="pun">],</span><span class="pln"> level</span><span class="pun">:</span><span class="pln"> </span><span class="str">'error'</span><span class="pun">}</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">});</span></code></li><li class="L2"><code class="lang-javascript"></code></li><li class="L3"><code class="lang-javascript"><span class="pln">let logger_Info </span><span class="pun">=</span><span class="pln"> log4js</span><span class="pun">.</span><span class="pln">getLogger</span><span class="pun">();</span><span class="pln"> </span><span class="com">//访问日志</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln">let logger_Error </span><span class="pun">=</span><span class="pln"> log4js</span><span class="pun">.</span><span class="pln">getLogger</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">);</span><span class="pln"> </span><span class="com">//错误日志</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln">module</span><span class="pun">.</span><span class="pln">exports </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> logger_Info</span><span class="pun">,</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> logger_Error</span></code></li><li class="L8"><code class="lang-javascript"><span class="pun">}</span></code></li></ol></pre>
                                <h5 id="h5--koa-"><a name="十、koa 插件配置" class="reference-link"></a><span
                                                class="header-link octicon octicon-link"></span>十、koa 插件配置</h5>
                                <p>1.跨域配置，引入<code>koa2-cors</code>。<br>2.处理Post请求和文件上传，引入<code>koa-body</code>。<br>3.记录全局错误日志文件。
                                </p>
                                <pre class="prettyprint linenums prettyprinted"
                                        style=""><ol class="linenums"><li class="L0"><code class="lang-javascript"><span class="com">//跨域配置</span></code></li><li class="L1"><code class="lang-javascript"><span class="pln">app</span><span class="pun">.</span><span class="pln">use</span><span class="pun">(</span><span class="pln">cors</span><span class="pun">({</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln"> origin</span><span class="pun">:</span><span class="pln"> </span><span class="str">'http://localhost:8080'</span><span class="pun">,</span><span class="pln"> </span><span class="com">//*表示接受所有访问</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> credentials</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span></code></li><li class="L4"><code class="lang-javascript"><span class="pun">}));</span></code></li><li class="L5"><code class="lang-javascript"><span class="pln">app</span><span class="pun">.</span><span class="pln">use</span><span class="pun">(</span><span class="pln">koaBody</span><span class="pun">({</span></code></li><li class="L6"><code class="lang-javascript"><span class="pln"> multipart</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">true</span><span class="pun">,</span><span class="pln"> </span><span class="com">//支持文件上传</span></code></li><li class="L7"><code class="lang-javascript"><span class="pln"> strict</span><span class="pun">:</span><span class="pln"> </span><span class="kwd">false</span><span class="pun">,</span><span class="pln"> </span><span class="com">//如果为true，不解析GET,HEAD,DELETE请求</span></code></li><li class="L8"><code class="lang-javascript"><span class="pln"> formidable</span><span class="pun">:</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L9"><code class="lang-javascript"><span class="pln"> maxFileSize</span><span class="pun">:</span><span class="pln"> </span><span class="lit">10</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1024</span><span class="pln"> </span><span class="pun">*</span><span class="pln"> </span><span class="lit">1024</span><span class="pln"> </span><span class="com">//限制10M大小</span></code></li><li class="L0"><code class="lang-javascript"><span class="pln"> </span><span class="pun">}</span></code></li><li class="L1"><code class="lang-javascript"><span class="pun">}))</span></code></li><li class="L2"><code class="lang-javascript"><span class="pln">app</span><span class="pun">.</span><span class="pln">on</span><span class="pun">(</span><span class="str">'error'</span><span class="pun">,</span><span class="pln"> err </span><span class="pun">=&gt;</span><span class="pln"> </span><span class="pun">{</span></code></li><li class="L3"><code class="lang-javascript"><span class="pln"> </span><span class="com">//捕获全局错误，打印错误日志</span></code></li><li class="L4"><code class="lang-javascript"><span class="pln"> logger_Error</span><span class="pun">.</span><span class="pln">error</span><span class="pun">(</span><span class="pln">err</span><span class="pun">);</span></code></li><li class="L5"><code class="lang-javascript"><span class="pun">})</span></code></li></ol></pre>
                                <p>欢迎转载，转载请注明出处。</p>
                        </div>
                </div>
        </main>
        <footer class="footer">
                <div class="footer-link">
                        <div>© 2018 - 2019</div>
                        <div><a target="_blank" href="http://github.com/hcLei"><img src="../../public/images/github.svg"
                                                alt="github"></a></div>
                        <div><a target="_blank"
                                        href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=BzY0MTc0Pj81MjFHdnYpZGhq"><img
                                                src="../../public/images/email.svg" alt="email"></a></div>
                </div>
                <div class="footer-info">
                        <div><img src="../../public/images/computer.svg" alt="computer"><a target="_blank"
                                        href="http://www.miibeian.gov.cn">渝ICP备16007578号</a></div>
                </div>
        </footer>
</body>

</html>