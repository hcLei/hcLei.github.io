<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <title>使用python采集全球省(州)、市、区(县)主要城市的坐标</title>
    <link rel='stylesheet' href='../../public/markdown.min.css' />
    <link rel='stylesheet' href='../../public/style.css' />
    <link rel="icon" type="image/png" href="../../public/images/icon.png" sizes="32x32">
    <meta name="description"
        content="个人博客网站，专注于分享技术知识，包括但不限于HTML5、CSS3、JavaScript、Nodejs、Linux、Python、Nginx、React、Vue、Angular">
    <meta name="keywords"
        content="个人、博客、技术、互联网、分享、笔记、前端开发、HTML5、CSS3、JavaScript、Nodejs、Linux、Python、Nginx、React、Vue、Angular">
</head>

<body>
    <header class="header">
        <div class="header-inner">
            <div class="header-title">
                <a href="../../">致力于分享与进步</a>
            </div>
        </div>
    </header>
    <main class="main">
        <div class="main-inner">
            <div class="content-item">
                <p class="content-title"><a>使用python采集全球省(州)、市、区(县)主要城市的坐标</a></p>
                <p class="content-createTime"><img src="../../public/images/date.svg" alt="date">发表于 2019-01-19</p>
            </div>
            <div class="content-description">
                <p>最近团队项目有个需求，将满足业务条件的城市在地图上标记出来，也就是实现一个简单的地图，然后用标记点展示部分城市。起初打算将echarts和百度地图API相结合，但是UCD反馈说不需要这么复杂，只需要有一个国家之间的大概轮廓，然后能展示城市名称就行。
                </p>
                <hr>
                <h3 id="h3-1-echarts-"><a name="1. 使用echarts画出地图上国家之间的边界轮廓" class="reference-link"></a><span
                        class="header-link octicon octicon-link"></span>1. 使用echarts画出地图上国家之间的边界轮廓</h3>
                <p>首先需要将全球213个国家和地区的轮廓画出来，<a
                        href="https://echarts.baidu.com/download-map.html">echarts</a>现在已经不提供geoJSON地图格式的数据文件供大家下载，所以只能在网上找了份别人共享的文件，然后根据echarts官网的<a
                        href="https://echarts.baidu.com/option.html#geo">地图绘制教程</a>,模拟一些城市坐标数据，就可以将其标记到地图上。这里就暂时不列出具体代码了，有兴趣的可以去官网研究地图实例。
                </p>
                <h3 id="h3-2-"><a name="2. 采集全球省(州)、市、区(县)主要城市的名称" class="reference-link"></a><span
                        class="header-link octicon octicon-link"></span>2. 采集全球省(州)、市、区(县)主要城市的名称</h3>
                <p>全球主要城市数量非常庞大，没法独自去收集，只能采取变通的方法。平时我们在使用QQ或者微信的时候，可以设置所在的国家和地区，通过网上搜索，发现腾讯QQPC端有国内版本和国外版本，可以在软件目录中的I18N目录下分别找到对应的的XML文档，有中文版的城市和英文版的城市。国内城市名称可以使用中文版，国外城市名称可以使用英文版。
                </p>
                <h3 id="h3-3-api-"><a name="3. 选取合适的城市坐标数据API采集接口" class="reference-link"></a><span
                        class="header-link octicon octicon-link"></span>3. 选取合适的城市坐标数据API采集接口</h3>
                <p>目前内部暂时没有全球主要城市名称和经纬度一一对应的数据，后台开发人员抱怨说网上找不到现成的数据，但是我以前用过百度地图部分API，查了下百度地图开发文档中的<a
                        href="http://lbsyun.baidu.com/index.php?title=webapi/guide/webservice-geocoding">地理编码</a>服务，无奈该服务只支持根据国内的城市名称查询对应的经纬度数据，不支持国外城市的查询服务(包括高德地图等国内服务商都不支持)，然后又去查阅了google地图服务和必应地图服务的开发者文档，最后决定使用<a
                        href="https://docs.microsoft.com/en-us/bingmaps/rest-services/locations/find-a-location-by-query">必应地图地理编码</a>服务(goolge地图服务需要绑定信用卡并且只免费一年),但是必应地图对国内的部分中文城市支持不友好，所以采取两套数据采集方案：<strong>国内城市坐标采集使用百度地图API</strong>，<strong>国外城市坐标采集使用必应地图API</strong>。
                </p>
                <h3 id="h3-3-python-"><a name="3. 使用python采集主要城市的坐标数据" class="reference-link"></a><span
                        class="header-link octicon octicon-link"></span>3. 使用python采集主要城市的坐标数据</h3>
                <p>内部提供的Python语法是2.7，暂时无法使用3.X版本，Python语法学习可以访问<a
                        href="https://www.liaoxuefeng.com/wiki/0014316089557264a6b348958f449949df42a6d3a2e542c000">廖雪峰的教程</a>，然后开始代码实现采集坐标。<br>1.首先需要将XML文档转为JSON数据格式文档
                </p>
                <pre class="prettyprint linenums prettyprinted"
                    style=""><ol class="linenums"><li class="L0"><code><span class="com">#! /usr/bin/env python </span></code></li><li class="L1"><code><span class="com"># -*- coding: utf-8 -*- </span></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> xmltodict</span><span class="pun">,</span><span class="pln"> json </span></code></li><li class="L3"><code><span class="kwd">import</span><span class="pln"> sys </span></code></li><li class="L4"><code><span class="pln">reload</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">sys</span><span class="pun">.</span><span class="pln">setdefaultencoding</span><span class="pun">(</span><span class="str">'utf-8'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L6"><code><span class="kwd">with</span><span class="pln"> open</span><span class="pun">(</span><span class="str">'en.xml'</span><span class="pun">,</span><span class="str">'r'</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">as</span><span class="pln"> f</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln"> str_xml </span><span class="pun">=</span><span class="pln"> str</span><span class="pun">(</span><span class="pln">f</span><span class="pun">.</span><span class="pln">read</span><span class="pun">())</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> str_xml </span><span class="pun">=</span><span class="pln"> str_xml</span><span class="pun">.</span><span class="pln">replace</span><span class="pun">(</span><span class="str">'&amp;'</span><span class="pun">,</span><span class="str">'&amp;#38;'</span><span class="pun">)</span><span class="pln"> </span><span class="com"># xml格式不能有"&amp;"符号 </span></code></li><li class="L9"><code><span class="pln"> doc </span><span class="pun">=</span><span class="pln"> xmltodict</span><span class="pun">.</span><span class="pln">parse</span><span class="pun">(</span><span class="pln">str_xml</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> f</span><span class="pun">=</span><span class="pln">open</span><span class="pun">(</span><span class="str">'encity.json'</span><span class="pun">,</span><span class="str">'w'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> f</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">json</span><span class="pun">.</span><span class="pln">dumps</span><span class="pun">(</span><span class="pln">doc</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln"> f</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span><span class="pln"> </span></code></li></ol></pre>
                <p>2.然后读取JSON数据，整理成国家—-省(直辖市、州)—市（区县）类型的格式，实现一一对应，比如中国—-重庆市—-万州区、中国—-湖北省—-武汉市</p>
                <pre class="prettyprint linenums prettyprinted"
                    style=""><ol class="linenums"><li class="L0"><code><span class="com">#! /usr/bin/env python </span></code></li><li class="L1"><code><span class="com"># -*- coding: utf-8 -*- </span></code></li><li class="L2"><code></code></li><li class="L3"><code><span class="pln">f</span><span class="pun">=</span><span class="pln">open</span><span class="pun">(</span><span class="str">'encity.json'</span><span class="pun">,</span><span class="str">'r'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">w</span><span class="pun">=</span><span class="pln">open</span><span class="pun">(</span><span class="str">'encity.md'</span><span class="pun">,</span><span class="str">'w'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">data </span><span class="pun">=</span><span class="pln"> json</span><span class="pun">.</span><span class="pln">load</span><span class="pun">(</span><span class="pln">f</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L6"><code><span class="kwd">for</span><span class="pln"> countryData </span><span class="kwd">in</span><span class="pln"> data</span><span class="pun">[</span><span class="str">'Location'</span><span class="pun">][</span><span class="str">'CountryRegion'</span><span class="pun">]:</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="str">'State'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> countryData </span><span class="kwd">and</span><span class="pln"> type</span><span class="pun">(</span><span class="pln">countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">]).</span><span class="pln">__name__</span><span class="pun">==</span><span class="str">'dict'</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln"> </span><span class="kwd">for</span><span class="pln"> </span><span class="pun">(</span><span class="pln">state</span><span class="pun">,</span><span class="pln">stateData</span><span class="pun">)</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">].</span><span class="pln">items</span><span class="pun">():</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">state </span><span class="pun">==</span><span class="pln"> </span><span class="str">"@Name"</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">stateData </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----state-----'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">state </span><span class="pun">==</span><span class="pln"> </span><span class="str">"City"</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> </span><span class="kwd">for</span><span class="pln"> cityData </span><span class="kwd">in</span><span class="pln"> stateData</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="str">'@Name'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> cityData</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">cityData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----city-----'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="str">'State'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> countryData </span><span class="kwd">and</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">])</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> type</span><span class="pun">(</span><span class="pln">countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">]).</span><span class="pln">__name__</span><span class="pun">==</span><span class="str">'list'</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln"> </span><span class="kwd">for</span><span class="pln"> stateData </span><span class="kwd">in</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'State'</span><span class="pun">]:</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">stateData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----state-----'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="str">'City'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> stateData </span><span class="kwd">and</span><span class="pln"> type</span><span class="pun">(</span><span class="pln">stateData</span><span class="pun">[</span><span class="str">'City'</span><span class="pun">]).</span><span class="pln">__name__</span><span class="pun">==</span><span class="str">'list'</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> </span><span class="kwd">for</span><span class="pln"> cityData </span><span class="kwd">in</span><span class="pln"> stateData</span><span class="pun">[</span><span class="str">'City'</span><span class="pun">]:</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="str">'@Name'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> cityData</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">cityData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----city-----'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="str">'City'</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> stateData </span><span class="kwd">and</span><span class="pln"> type</span><span class="pun">(</span><span class="pln">stateData</span><span class="pun">[</span><span class="str">'City'</span><span class="pun">]).</span><span class="pln">__name__</span><span class="pun">==</span><span class="str">'dict'</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> </span><span class="kwd">for</span><span class="pln"> city</span><span class="pun">,</span><span class="pln">cityData </span><span class="kwd">in</span><span class="pln"> stateData</span><span class="pun">[</span><span class="str">'City'</span><span class="pun">].</span><span class="pln">items</span><span class="pun">():</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln"> </span><span class="kwd">if</span><span class="pun">(</span><span class="pln">city </span><span class="pun">==</span><span class="pln"> </span><span class="str">'@Name'</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln"> w</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">cityData </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----city-----'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> countryData</span><span class="pun">[</span><span class="str">'@Name'</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'-----country-----'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">w</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">f</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span><span class="pln"> </span></code></li></ol></pre>
                <p>3.使用百度地图地理编码服务API采集国内主要城市坐标</p>
                <pre class="prettyprint linenums prettyprinted"
                    style=""><ol class="linenums"><li class="L0"><code><span class="com">#!/usr/bin/env python</span></code></li><li class="L1"><code><span class="com"># -*- coding: utf-8 -*- </span></code></li><li class="L2"><code><span class="kwd">import</span><span class="pln"> requests </span></code></li><li class="L3"><code><span class="kwd">import</span><span class="pln"> json </span></code></li><li class="L4"><code><span class="kwd">import</span><span class="pln"> re </span></code></li><li class="L5"><code><span class="kwd">import</span><span class="pln"> sys </span></code></li><li class="L6"><code><span class="pln">reload</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln">sys</span><span class="pun">.</span><span class="pln">setdefaultencoding</span><span class="pun">(</span><span class="str">'utf-8'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">headers </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">"User-Agent"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"</span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">proxies </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'http'</span><span class="pun">:</span><span class="pln"> xxx</span><span class="pun">,</span><span class="pln"> </span><span class="str">'https'</span><span class="pun">:</span><span class="pln"> xxx</span><span class="pun">}</span><span class="pln"> </span><span class="com">#内网限制，需要使用代理</span></code></li><li class="L0"><code><span class="pln">url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'http://api.map.baidu.com/geocoder/v2/'</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln">fr </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"zhcity.md"</span><span class="pun">,</span><span class="str">"r"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">fw </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"zhcitypoint.md"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"w"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> fr</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> item</span><span class="pun">=</span><span class="pln">line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">'-----'</span><span class="pun">)[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln"> </span><span class="kwd">params</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'address'</span><span class="pun">:</span><span class="pln"> item</span><span class="pun">,</span><span class="pln"> </span><span class="str">'ak'</span><span class="pun">:</span><span class="pln"> XXX</span><span class="pun">,</span><span class="pln"> </span><span class="str">'output'</span><span class="pun">:</span><span class="pln"> </span><span class="str">'json'</span><span class="pun">}</span><span class="pln"> </span><span class="com">#ak需要自己去百度地图开发者平台申请</span></code></li><li class="L6"><code><span class="pln"> res </span><span class="pun">=</span><span class="pln"> requests</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">params</span><span class="pun">=</span><span class="kwd">params</span><span class="pun">,</span><span class="pln"> headers</span><span class="pun">=</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"> proxies</span><span class="pun">=</span><span class="pln">proxies</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln"> pattern1 </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">compile</span><span class="pun">(</span><span class="pln">r</span><span class="str">'"lng":([\d\.]+),'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> res1 </span><span class="pun">=</span><span class="pln"> pattern1</span><span class="pun">.</span><span class="pln">findall</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">content</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln"> pattern2 </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">compile</span><span class="pun">(</span><span class="pln">r</span><span class="str">'"lat":([\d\.]+)\}'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> res2 </span><span class="pun">=</span><span class="pln"> pattern2</span><span class="pun">.</span><span class="pln">findall</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">content</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">res1</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span><span class="kwd">and</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">res2</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln"> fw</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">line</span><span class="pun">.</span><span class="pln">strip</span><span class="pun">(</span><span class="str">'\n'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'['</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> res1</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">','</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> res2</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">']'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> fw</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">line</span><span class="pun">.</span><span class="pln">strip</span><span class="pun">(</span><span class="str">'\n'</span><span class="pun">)</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'['</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">']'</span><span class="pln"> </span><span class="pun">+</span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">fr</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln">fw</span><span class="pun">.</span><span class="pln">close</span><span class="pun">()</span></code></li></ol></pre>
                <p>4.使用必应地图地理编码服务API采集国外主要城市坐标</p>
                <pre class="prettyprint linenums prettyprinted"
                    style=""><ol class="linenums"><li class="L0"><code><span class="com">#!/usr/bin/env python</span></code></li><li class="L1"><code><span class="com"># -*- coding: utf-8 -*- </span></code></li><li class="L2"><code><span class="kwd">from</span><span class="pln"> threading </span><span class="kwd">import</span><span class="pln"> </span><span class="typ">Thread</span><span class="pun">,</span><span class="pln"> </span><span class="typ">Lock</span><span class="pln"> </span></code></li><li class="L3"><code><span class="kwd">import</span><span class="pln"> requests </span></code></li><li class="L4"><code><span class="kwd">import</span><span class="pln"> json </span></code></li><li class="L5"><code><span class="kwd">import</span><span class="pln"> re </span></code></li><li class="L6"><code><span class="kwd">import</span><span class="pln"> sys </span></code></li><li class="L7"><code><span class="pln">reload</span><span class="pun">(</span><span class="pln">sys</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln">sys</span><span class="pun">.</span><span class="pln">setdefaultencoding</span><span class="pun">(</span><span class="str">'utf-8'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln">headers </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="pln"> </span><span class="str">"User-Agent"</span><span class="pun">:</span><span class="pln"> </span><span class="str">"Mozilla/5.0 (Windows NT 6.1; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/71.0.3578.98 Safari/537.36"</span><span class="pun">}</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln">proxies </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'http'</span><span class="pun">:</span><span class="pln"> xxx</span><span class="pun">,</span><span class="pln"> </span><span class="str">'https'</span><span class="pun">:</span><span class="pln"> xx</span><span class="pun">}</span><span class="pln"> </span><span class="com">#内网限制，需要使用代理</span></code></li><li class="L1"><code><span class="pln">url </span><span class="pun">=</span><span class="pln"> </span><span class="str">'http://dev.virtualearth.net/REST/v1/Locations'</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln">fr </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"encity1.md"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"r"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln">fw </span><span class="pun">=</span><span class="pln"> open</span><span class="pun">(</span><span class="str">"encitypoint1.md"</span><span class="pun">,</span><span class="pln"> </span><span class="str">"a"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln">items </span><span class="pun">=</span><span class="pln"> </span><span class="pun">[]</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln">a </span><span class="pun">=</span><span class="pln"> </span><span class="lit">0</span><span class="pln"> </span></code></li><li class="L6"><code><span class="kwd">for</span><span class="pln"> line </span><span class="kwd">in</span><span class="pln"> fr</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L7"><code><span class="pln"> item </span><span class="pun">=</span><span class="pln"> line</span><span class="pun">.</span><span class="pln">split</span><span class="pun">(</span><span class="str">'-----'</span><span class="pun">)[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> items</span><span class="pun">.</span><span class="pln">append</span><span class="pun">(</span><span class="pln">item</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln"> </span><span class="kwd">def</span><span class="pln"> query1</span><span class="pun">():</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> </span><span class="kwd">global</span><span class="pln"> a </span></code></li><li class="L1"><code><span class="pln"> </span><span class="kwd">global</span><span class="pln"> items </span></code></li><li class="L2"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">items</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&lt;=</span><span class="pln"> a</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> </span><span class="kwd">return</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> </span><span class="kwd">lock</span><span class="pun">.</span><span class="pln">acquire</span><span class="pun">()</span><span class="pln"> </span><span class="com">#需要对变量a递增，为了避免多个线程同时读取，需要在+1的时候锁定，+1结束后再释放</span></code></li><li class="L5"><code><span class="pln"> line </span><span class="pun">=</span><span class="pln"> items</span><span class="pun">[</span><span class="pln">a</span><span class="pun">]</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln"> </span><span class="kwd">params</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="pun">{</span><span class="str">'q'</span><span class="pun">:</span><span class="pln"> items</span><span class="pun">[</span><span class="pln">a</span><span class="pun">],</span><span class="pln"> </span><span class="str">'key'</span><span class="pun">:</span><span class="pln"> XXX</span><span class="pun">}</span><span class="pln"> </span><span class="com">#key需要自己去必应地图开发者平台申请</span></code></li><li class="L7"><code><span class="pln"> a </span><span class="pun">+=</span><span class="pln"> </span><span class="lit">1</span><span class="pln"> </span></code></li><li class="L8"><code><span class="pln"> </span><span class="kwd">lock</span><span class="pun">.</span><span class="pln">release</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L9"><code><span class="pln"> res </span><span class="pun">=</span><span class="pln"> requests</span><span class="pun">.</span><span class="kwd">get</span><span class="pun">(</span><span class="pln">url</span><span class="pun">,</span><span class="pln"> </span><span class="kwd">params</span><span class="pun">=</span><span class="kwd">params</span><span class="pun">,</span><span class="pln"> headers</span><span class="pun">=</span><span class="pln">headers</span><span class="pun">,</span><span class="pln"> proxies</span><span class="pun">=</span><span class="pln">proxies</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L0"><code><span class="pln"> pattern1 </span><span class="pun">=</span><span class="pln"> re</span><span class="pun">.</span><span class="pln">compile</span><span class="pun">(</span><span class="pln">r</span><span class="str">'"coordinates":(\[[-\d\.,]+\])'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> result </span><span class="pun">=</span><span class="pln"> pattern1</span><span class="pun">.</span><span class="pln">findall</span><span class="pun">(</span><span class="pln">res</span><span class="pun">.</span><span class="pln">text</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L2"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">len</span><span class="pun">(</span><span class="pln">result</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> </span><span class="lit">0</span><span class="pun">):</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> fw</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">line </span><span class="pun">+</span><span class="pln"> </span><span class="str">"-----"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> result</span><span class="pun">[</span><span class="lit">0</span><span class="pun">]</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln"> fw</span><span class="pun">.</span><span class="pln">write</span><span class="pun">(</span><span class="pln">line </span><span class="pun">+</span><span class="pln"> </span><span class="str">"-----"</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">'['</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">']'</span><span class="pln"> </span><span class="pun">+</span><span class="pln"> </span><span class="str">"\n"</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L6"><code><span class="pln"> </span><span class="kwd">lock</span><span class="pln"> </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Lock</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L7"><code></code></li><li class="L8"><code><span class="pln">t1 </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Thread</span><span class="pun">(</span><span class="pln">target</span><span class="pun">=</span><span class="pln">query1</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'t1'</span><span class="pun">)</span><span class="pln"> </span><span class="com">#必应API接口非常慢，内网采集时每次请求大概需要一分钟，所以需要开多个线程同时跑</span></code></li><li class="L9"><code><span class="pln">t1</span><span class="pun">.</span><span class="pln">start</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L0"><code><span class="kwd">while</span><span class="pln"> len</span><span class="pun">(</span><span class="pln">items</span><span class="pun">)</span><span class="pln"> </span><span class="pun">&gt;</span><span class="pln"> a</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L1"><code><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">(</span><span class="pln">t1</span><span class="pun">.</span><span class="pln">isAlive</span><span class="pun">()</span><span class="pln"> </span><span class="kwd">is</span><span class="pln"> </span><span class="kwd">False</span><span class="pun">):</span><span class="pln"> </span><span class="com">#当线程被kill后，需要重新建立一个</span></code></li><li class="L2"><code><span class="pln"> t1 </span><span class="pun">=</span><span class="pln"> </span><span class="typ">Thread</span><span class="pun">(</span><span class="pln">target</span><span class="pun">=</span><span class="pln">query1</span><span class="pun">,</span><span class="pln"> name</span><span class="pun">=</span><span class="str">'t1'</span><span class="pun">)</span><span class="pln"> </span></code></li><li class="L3"><code><span class="pln"> t1</span><span class="pun">.</span><span class="pln">start</span><span class="pun">()</span><span class="pln"> </span></code></li><li class="L4"><code><span class="pln"> </span><span class="kwd">else</span><span class="pun">:</span><span class="pln"> </span></code></li><li class="L5"><code><span class="pln"> query1</span><span class="pun">()</span></code></li></ol></pre>
                <p>5.将整理出来的数据发给后台人员，导入到数据库即可。在实际应用后，还是有少量的数据坐标有偏差。比如必应地图采集城市名为white
                    Russia时，实际采集的是Russia的坐标，真正的白俄罗名称是Belarus。最后就可以通过接口拿到想要的城市名称和经纬度坐标，结合Echarts实现展示功能。</p>
                <h3 id="h3-4-"><a name="4. 总结" class="reference-link"></a><span
                        class="header-link octicon octicon-link"></span>4. 总结</h3>
                <p>1.这次的需求需要用到大量的经纬度坐标，即使内部或者网上没有现成的数据，也得想办法灵活的实现，平时多浏览一些技术论坛和文章，技术Ideal自然就多起来了。<br>2.在Pyhon代码实现的过程中，光看教程是不够的，还要结合实际需求，一些Python语法报错，需要去网上搜索报错原因，然后进行纠正，多踩点坑就慢慢熟练起来了。<br>3.利用Python也可以做一些其他自动化的工作，平时开发中我也会做一些数据比对的工作，使用Python提供的读写Excel插件和数据库插件，利用SQL语句动态的从数据库读取每条数据，然后跟Excel中的数据进行比对，最后输出一份含有比对结果的Excel文档。
                </p>
                <p>欢迎转载，转载请注明出处。</p>
            </div>
        </div>
    </main>
    <footer class="footer">
        <div class="footer-link">
            <div>© 2018 - 2019</div>
            <div><a target="_blank" href="http://github.com/hcLei"><img src="../../public/images/github.svg"
                        alt="github"></a></div>
            <div><a target="_blank"
                    href="http://mail.qq.com/cgi-bin/qm_share?t=qm_mailme&email=BzY0MTc0Pj81MjFHdnYpZGhq"><img
                        src="../../public/images/email.svg" alt="email"></a></div>
        </div>
        <div class="footer-info">
            <div><img src="../../public/images/computer.svg" alt="computer"><a target="_blank"
                    href="http://www.miibeian.gov.cn">渝ICP备16007578号</a></div>
        </div>
    </footer>
</body>

</html>